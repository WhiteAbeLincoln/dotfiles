#!/usr/bin/env bash

function workspaces {
    temp=$(wmctrl -d | awk '{ cols=$1","$2","; if (NF==10) print cols $10; else print cols $9 }')
    i=0
    for elem in $temp; do
        WORKSPACES[$i]=$elem;
        re=',\*,'
        if [[ $elem =~ $re ]]; then
            CURRENT_WS=$elem
        fi
        (( i+=1 ))
    done

    temp=$(wmctrl -l | awk '{ s=""; for (i=4; i<=NF; i++) s=s $i " "; print $2 "," s }' )
    IFS=$'\n'
    i=0
    for elem in $temp; do
        WINDOWS[$i]=$elem;
        IFS=',' read -ra idx <<< "$elem"
        IFS=',' read -ra space <<< "${WORKSPACES[${idx[0]}]}"
        ACTIVE_WORKSPACES[${idx[0]}]="${space[2]}"
        (( i+=1 ))
        unset space
    done

    IFS=',' read -ra idx <<< "$CURRENT_WS"
    colorized="%{F$COLORS_color2}${idx[2]}%{F$COLORS_foreground}"
    if [[ ${ACTIVE_WORKSPACES[${idx[0]}]} ]]; then
        ACTIVE_WORKSPACES=("${ACTIVE_WORKSPACES[@]/"${idx[2]}"/"$colorized"}")
    else
        ACTIVE_WORKSPACES[${idx[0]}]="$colorized"
    fi

    ACTIVE_WINDOW=$(xdotool getwindowfocus getwindowname)

    unset i
    unset re
    unset idx
    unset temp
    unset IFS
    unset colorized
}

function get_workspaces {
    workspaces
    IFS=',' read -ra idx <<< "$CURRENT_WS"
    x=${idx[0]}
    y=$(( (x+1) % 9))
    (( x-=1 ))

    if (( x < 0 )); then
        (( x = 8 ))
    fi

    if [[ ${#ACTIVE_WINDOW} -gt 50 ]]; then
        ACTIVE_WINDOW="${ACTIVE_WINDOW:0:49}..."
    fi

    echo -n %{F$COLORS_foreground}%{A4:wmctrl -s $y:}%{A5:wmctrl -s $x:}"${ACTIVE_WORKSPACES[@]}"%{A}%{A} : %{F$COLORS_color1}$ACTIVE_WINDOW%{F$COLORS_foreground}
}

function clock {
    DATE=$(date "+%a %b %d")
    TIME=$(date "+%H:%M")
}

function get_clock {
    clock
    echo -n "%{F$COLORS_color2}$DATE $TIME%{F$COLORS_foreground}"
}

function music {
    CURRENT_SONG=$(mpc | head -1)
    SONGTIME=$(mpc -f %time% | grep "\[" | awk '{print $3}')
    STATUS=$(mpc -f %time% | grep -oe "\[.*\]")

    if [[ "$STATUS" == "[playing]" ]]; then
        STATUS=""
    fi

    if [[ "$(mpc | head -1 | awk -F: '{print $1}')" == "volume" ]]; then
        CURRENT_SONG="[NONE]"
    fi
}

function get_music {
    music
    string="%{A:mpc toggle:}%{A4:mpc next:}%{A5:mpc prev:}$CURRENT_SONG%{A}%{A}%{A}"
    if [[ -z "$STATUS" ]]; then
        echo -en "%{F$COLORS_color12}\uf04b ${string}%{F$COLORS_foreground}"
    else
        echo -en "%{F$COLORS_color9}\uf04c ${string}%{F$COLORS_foreground}"
    fi
}

function weather {
    date=$(date "+%H_%M")
        if [[ -f "$HOME/.weather$date" ]]; then
            WEATHER=$(cat "$HOME/.weather$date")
        else
            if [[ -f "$HOME"/.weather* ]]; then
                rm "$HOME"/.weather*
            fi
            WEATHER=$(wget -q -O- http://www.accuweather.com/en/us/logan-ut/84321/weather-forecast/331213 | awk -F[\"\'] '/acm_RecentLocationsCarousel\.push/{print $2": "$16", "$12"°" }' | head -1)
            echo $WEATHER > "$HOME/.weather$date"
        fi
}

function get_weather {
    weather
    echo -en "%{F$COLORS_color14}$WEATHER%{F$COLORS_foreground}"
}

function volume {
    VOLUME=$(ponymix get-volume)
    $(ponymix is-muted)
    STATUS=$?
}

function get_volume {
    volume
    scroll="%{A:ponymix toggle:}"
    end_scroll="%{A}"
    if [[ ! "$STATUS" == "0" ]]; then
        echo -en "%{F$COLORS_color10}${scroll}\uf028 $VOLUME%${end_scroll}%{F$COLORS_foreground}"
    else
        echo -en "%{F$COLORS_color9}${scroll}\uf026 $VOLUME%${end_scroll}%{F$COLORS_foreground}"
    fi
}

function power {
    if [[ -d "/sys/class/power_supply/BAT0" ]]; then
        CAPACITY=$(cat /sys/class/power_supply/BAT0/capacity)
        BAT_STATUS=$(cat /sys/class/power_supply/BAT0/status)
    fi
}

function get_power {
    power
    color_red="#ff432d"
    color_yellow="#ffc32d"
    color_green="#43a32d"
    color_out=$color_green

    if [[ $BAT_STATUS == "Charging" ]] || [[ $BAT_STATUS == "Full" ]]; then
        bat_symbol="\uf0e7"
    elif [[ $BAT_STATUS == "Discharging" ]]; then
        bat_symbol="\uf241"
    else
        bat_symbol="?"
    fi

    if [[ $CAPACITY -gt "66" ]]; then
        color_out=$color_green
    elif [[ $capacity -gt "33" ]]; then
        color_out=$color_yellow
    else
        color_out=$color_red
    fi

    echo -en "%{F$color_out}$bat_symbol $CAPACITY%{F$COLORS_foreground}"
}

function network {
    if [[ -e "/proc/net/wireless" ]]; then
        WIRELESS_STATUS=$(cat /proc/net/wireless | awk '/^w/ {print $3}' | grep -Eo '[[:digit:]]+')
        WIRELESS_STATUS=$(( WIRELESS_STATUS*100/70 ))
    fi
}

function get_network {
    network
    string=""
    i=0
    while (( WIRELESS_STATUS > 0 )); do
        wifi_stat="$wifi_stat\xe2\x80\xa2"
        (( WIRELESS_STATUS-=25 ))
    done
    echo -en "%{F$COLORS_color2}$wifi_stat%{F$COLORS_foreground}"
}

function set_sleep {
    echo -en "%{F$COLORS_color1}%{A:systemctl suspend:}\uf011%{A}%{F$COLORS_foreground}"
}

while true; do
    source ~/.barrc
    buff=""
    buff="${buff}%{B$COLORS_background}"
    buff="${buff}%{l} $(get_workspaces) "
    buff="${buff}%{c}$(get_clock) "
    buff="${buff}%{r}$(get_music) ║ $(get_volume) ║ $(get_network)"
    if [[ -d "/sys/class/power_supply/BAT0" ]]; then
        buff="${buff} ║ $(get_power)"
    fi
    buff="${buff} %{F-}%{B-}"

    echo $buff
    sleep .20;
done

# vim:syn=sh
